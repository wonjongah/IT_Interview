<u>서브쿼리(Subquery)란 하나의 SQL문 안에 포함되어 있는 또 다른 SQL문을 말한다.</u>

<u>서브쿼리는 알려지지 않은 기준을 이용한 검색을 위해 사용한다.</u>

<u>메인쿼리가 서브쿼리를 포함하는 종속관계이다.</u>



조인은 조인에 참여한느 모든 테이블이 대등한 관계에 있기 때문에 조인에 참여하는 모든 테이블의 칼럼을 어느 위치에서라도 자유롭게 사용할 수 있다.

<u>그러나 서브쿼리는 메인쿼리의 칼럼을 모두 사용할 수 있지만, 메인쿼리는 서브쿼리의 칼럼을 사용할 수 없다.</u>

<u>질의 결과에 서브쿼리 칼럼을 표시해야 한다면 조인 방식으로 변환하거나 함수, 스칼라 서브쿼리 등을 이용해야 한다.</u>



조인은 집합간의 곱(Product)의 관계이다.

즉, 1:1 관계의 테이블이 조인하면 1(= 1*1) 레벨의 집합이 생성되고, 1:M 레벨의 집합이 결과로서 생성된다.

<u>그러나 서브쿼리는 서브쿼리 레벨과는 상관없이 항상 메인쿼리 레벨로 결과 집합이 생성된다.</u>

예를 들어, 메인쿼리로 조직(1), 서브쿼리로 사원(M) 테이블을 사용하면 결과 집합은 조직(1)레벨이 된다.

<u>원하는 레벨이 무엇이지 생각해서 조인을 사용해야 할 지, 서브쿼리를 사용해야 할 지 생각해야 한다.</u>



서브쿼리를 사용할 때 다음 사항에 주의해야 한다.

1. 서브쿼리를 괄호로 감싸서 사용한다.
2. 서브쿼리는 단일 행 또는 복수 행 비교 연산자와 함께 사용 가능하다. 단일 행 비교 연산자는 서브쿼리의 결과가 반드시 1건 이하여야 하고 복수 행 비교 연산자는 서브쿼리의 결과 건수와 상관 없다.
3. 서브쿼리에서는 ORDER BY를 사용하지 못한다. ORDER BY 절은 SELECT 절에서 오직 한 개만 올 수 있기 때문에 ORDER BY 절은 메인쿼리의 마지막 문장에 위치해야 한다.



서브쿼리가 SQL문에서 사용이 가능한 곳은 다음과 같다.

- SELECT 절
- FROM 절
- WHERE 절
- HAVING 절
- ORDER BY 절
- INSERT문의 VALUES 절
- UPDATE문의 SET절

서브쿼리의 종류는 동작하는 방식이나 반환되는 데이터의 형태에 따라 분류할 수 있다.

##### 동작하는 방식에 따른 서브쿼리 분류

| 서브쿼리 종류                  | 설명                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| Un-Correlated(비연관) 서브쿼리 | 서브쿼리가 메인쿼리 칼럼을 가지고 있지 않는 형태의 서브쿼리이다.메인쿼리에 값(서브쿼리가 실행된 결과)을 제공하기 위한 목적으로 주로 사용한다. |
| Correlated(연관) 서브쿼리      | 서브쿼리가 메인쿼리 칼럼을 가지고 있는 형태의 서브쿼리이다. 일반적으로 메인쿼리가 먼저 수행되어 읽혀진 데이터를 서브쿼리에서 조건이 맞는지 확인하고자 할 때 주로 사용된다. |



서브쿼리는 메인쿼리 안에 포함된 종속적인 관계이기 때문에 논리적인 실행순서는 항상 메인쿼리에서 읽혀진 데이터에 대해 서브쿼리에서 해당 조건이 만족하지를 확인하는 방식으로 수행되어야 한다.

반환되는 데이터의 형태에 따라 서브쿼리는 표와 같이 세 가지로 분류된다.

##### 반환되는 데이터의 형태에 따른 서브쿼리 분류

| 서브쿼리 종류                             | 설명                                                         |
| ----------------------------------------- | ------------------------------------------------------------ |
| Single Row 서브쿼리(단일 행 서브쿼리)     | 서브쿼리의 실행 결과가 항상 1건 이하인 서브쿼리를 의미한다. 단일 행 서브쿼리는 단일 행 비교 연산자와 함께 사용된다. 단일 행 비교 연산자는 =, <, <=, >, >=, <>이 있다. |
| Multi Row 서브쿼리(다중 행 서브쿼리)      | 서브쿼리의 실행 결과가 여러 건인 서브쿼리를 의미한다. 다중 행 서브쿼리는 다중 행 비교 연산자와 함께 사용된다. 다중 행 비교 연산자에는 IN, ALL, ANY, SOME, EXISTS가 있다. |
| Multi Column 서브쿼리(다중 칼럼 서브쿼리) | 서브쿼리의 실행 결과로 여러 칼럼을 반환한다. 메인쿼리의 조건절에 여러 칼럼을 동시에 비교할 수 있다. 서브쿼리와 메인쿼리에서 비교하고자 하는 칼럼 개수와 칼럼의 위치가 동일해야 한다. |



#### 1. 단일 행 서브쿼리

서브쿼리가 단일 행 비교 연산자 <=, <, =, >=, <>와 함께 사용할 때는 서브쿼리의 결과 건수가 반드시 1건 이하여야 한다.

<u>만약 서브쿼리의 결과 건수가 2건 이상을 반환하면 SQL문은 실행시간 오류가 발생한다.</u>



EX) 정남일 선수가 소속된 팀의 선수들에 대한 정보를 표시하는 문제를 서브쿼리 방식의 SQL문으로 작성하면 다음과 같다.

```SQL
SELECT PLAYER_NAME 선수명, POSITION 포지션, BACK_NO 백넘버
FROM PLAYER
WHERE TEAM_ID = (SELECT TEAM_ID
FROM PLAYER
WHERE PLAYER_NAME = '정남일')
ORDER BY PLAYER_NAME;
```

```
선수명                                   포지션                   백넘버
---------------------------------------- -------------------- ----------
강철                                     DF                            3
김반                                     MF                           14
김영수                                   MF                           30
김정래                                   GK                           33
김창원                                   DF                            5
김회택                                   DF
꼬레아                                   FW                           16
노병준                                   MF                           22
노상래                                   FW                            8
마시엘                                   DF                           24
서현옥                                   DF
```

정남일 선수의 소속팀을 알아내는 서브쿼리가 먼저 수행되어 정남일 선수의 소속팀 코드가 반환된다.

그뒤 메인쿼리는 서브쿼리에서 반환된 결과를 이용해서 조건을 만족하는 선수들의 정보를 출력한다.

<u>만일, 정남일 선수가 동명이인이었다면 2건 이상의 결과가 반환되어 SQL문은 오류가 발생될 것이다.</u>



테이블 전체에 하나의 그룹함수를 적용할 때는 그 결과 값이 1건이 생성되기 때문에 단일 행 서브쿼리로서 사용 가능하다.



EX) 선수들의 평균키를 알아내는 SQL문과 이 결과를 이용해서 키가 평균 이하의 선수들의 정보를 출력하는 SQL문으로 구성된다.

```SQL
SELECT PLAYER_NAME 선수명, POSITION 포지션, BACK_NO 백넘버
FROM PLAYER
WHERE HEIGHT <= (SELECT AVG(HEIGHT) FROM PLAYER)
ORDER BY PLAYER_NAME;
```

```
선수명                                   포지션                   백넘버
---------------------------------------- -------------------- ----------
가비                                     MF                           10
강대희                                   MF                           26
강용                                     DF                            2
강정훈                                   MF                           38
강철                                     DF                            3
고규억                                   DF                           29
고민기                                   FW                           24
고종수                                   MF                           22
고창현                                   MF                            8
공오균                                   MF                           22
곽기훈                                   FW                           33
```



#### 2. 다중 행 서브쿼리

서브쿼리의 결과가 2건 이상 반환될 수 있다면 반드시 비교 연산자(IN, ALL, ANY, SOME)와 함께 써야 한다.

##### 다중 행 비교 연산자

| 다중 행 연산자            | 설명                                                         |
| ------------------------- | ------------------------------------------------------------ |
| IN (서브쿼리)             | 서브쿼리의 결과에 존재하는 임의의 값과 동일한 조건을 의미한다. (Multiple OR 조건) |
| 비교연산자 ALL (서브쿼리) | 서브쿼리의 결과에 존재한느 모든 값을 만족하는 조건을 의미한다. 비교 연산자로 >를 사용했다면 메인쿼리는 서브쿼리의 모든 결과 값을 만족해야 하므로, 서브쿼리 결과의 최대값보다 큰 모든 건이 조건을 만족한다. |
| 비교연산자 ANY (서브쿼리) | 서브쿼리의 결과에 존재하는 어느 하나의 값이라도 만족하는 조건을 의미한다. 비교연산자로 >를 사용했다면 메인쿼리는 서브쿼리의 값들 중 어떤 값이라도 만족하면 되므로, 서브쿼리의 결과의 최소값보다 큰 모든 건이 조건을 만족한다. (SOME은 ANY와 동일함) |
| EXISTS (서브쿼리)         | 서브쿼리의 결과를 만족하는 값이 존재하는지 여부를 확인하는 조건을 의미한다. 조건을 만족하는 건이 여러 건이더라도 1건만 찾으면 더 이상 검색하지 않는다. |



EX) 선수들 중에서 '정현수'라는 선수가 소속되어 있는 팀 정보를 출력하는 서브쿼리를 작성하면 다음과 같다.

```SQL
SELECT REGION_NAME 연고지명, TEAM_NAME 팀명, E_TEAM_NAME 영문팀명
FROM TEAM
WHERE TEAM_ID = (SELECT TEAM_ID FROM PLAYER WHERE PLAYER_NAME = '정현수')
ORDER BY TEAM_NAME;
```

ERROR -> ORA-01427: single-row subquery returns more than one row

단일 행 하위 질의에 2개 이산의 행이 리턴되었다.

따라서 다중 행 비교 연산자로 바꾸어서 SQL문을 작성하면 된다.

```SQL
SELECT REGION_NAME 연고지명, TEAM_NAME 팀명, E_TEAM_NAME 영문팀명
FROM TEAM
WHERE TEAM_ID IN (SELECT TEAM_ID FROM PLAYER WHERE PLAYER_NAME = '정현수')
ORDER BY TEAM_NAME;
```

```
연고지명
----------------
팀명
--------------------------------------------------------------------------------
영문팀명
--------------------------------------------------------------------------------
전남
드래곤즈
CHUNNAM DRAGONS FC

성남
일화천마
SEONGNAM ILHWA CHUNMA FC
```

실행결과를 보면 정현수라는 이름을 가진 선수가 두 명 존재한다. 

서브쿼리의 실행 결과가 2건 이상 나오는 모든 경우에는 다중 행 연산자를 사용해야 한다.



#### 3. 다중 칼럼 서브쿼리

<u>다중 칼럼 서브쿼리는 서브쿼리의 결과로 여러 개의 칼럼이 반환되어 메인쿼리의 조건과 동시에 비교되는 것을 의미한다.</u>



EX) 소속팀별 키가 가장 작은 사람들의 정보를 출력하라.

```SQL
SELECT TEAM_ID 팀코드, PLAYER_NAME 선수명, POSITION 포지션, BACK_NO 백넘버, HEIGHT 키
FROM PLAYER
WHERE (TEAM_ID, HEIGHT) IN (SELECT TEAM_ID, MIN(HEIGHT) FROM PLAYER GROUP BY TEAM_ID)
ORDER BY TEAM_ID, PLAYER_NAME;
```

```
팀코드 선수명                                   포지션                   백넘버
------ ---------------------------------------- -------------------- ----------
        키
----------
K01    마르코스                                 FW                           44
       170

K01    박정수                                   MF                            8
       170

K02    고창현                                   MF                            8
       170
```

SQL문의 실행 결과를 보면 서브쿼리의 결과값으로 소속팀코드와 소속팀별 가장 작은 키를 의미하는 MIN(HEIGHT)라는 두 개의 칼럼을 반환했다.

메인쿼리에서는 조건절에 TEAM_ID와 HEIGHT 칼럼을 괄호로 묶어서 서브쿼리 결과와 비교하여 원하는 결과를 얻었다.



#### 4. 연관 서브쿼리

<u>연관 서브쿼리는 서브쿼리 내에 메인쿼리 칼럼이 사용된 서브쿼리이다.</u>



EX) 선수 자신이 속한 팀의 평균 키보다 작은 선수들의 정보를 출력하는 SQL문을 연관 서브쿼리를 이용해서 작성해보자.

```SQL
SELECT T.TEAM_NAME 팀명, M.PLAYER_NAME 선수명, M.POSITION 포지션, M.BACK_NO 백넘버, M.HEIGHT 키
FROM PLAYER M, TEAM T
WHERE M.TEAM_ID = T.TEAM_ID
AND M.HEIGHT < (SELECT AVG(HEIGHT) FROM PLAYER S WHERE S.TEAM_ID = M.TEAM_ID
AND S.HEIGHT IS NOT NULL GROUP BY S.TEAM_ID)
ORDER BY 선수명;
```

```
팀명
--------------------------------------------------------------------------------
선수명                                   포지션                   백넘버
---------------------------------------- -------------------- ----------
        키
----------
삼성블루윙즈
가비                                     MF                           10
       177

삼성블루윙즈
강대희                                   MF                           26
       174
```

팀의 평균키를 구하고, 그 평균키와 선수의 키를 비교한 후 출력하거나 출력하지 않는다.

이 작업을 메인쿼리에 존재하는 모든 행에 대해서 반복 수행한다.



EXISTS 서브쿼리는 항상 연관 서브쿼리로 사용된다.

또한 EXISTS 서브쿼리의 특징은 아무리 조건을 만족하는 건이 여러 건이더라도 조건을 만족한느 1건만 찾으면 추가적인 검색을 진행하지 않는다.

EX) 20120501부터 20120502 사이에 경기가 있는 경기장을 조회하는 SQL문.

```SQL
SELECT STADIUM_ID ID, STADIUM_NAME 경기장명
FROM STADIUM A
WHERE EXISTS (SELECT 1 FROM SCHEDULE X WHERE X.STADIUM_ID = A.STADIUM_ID
AND X.SCHE_DATE BETWEEN '20120501' AND '20120502');
```

```
ID
------
경기장명
--------------------------------------------------------------------------------
B01
인천월드컵경기장

B04
수원월드컵경기장

B05
서울월드컵경기장


ID
------
경기장명
--------------------------------------------------------------------------------
C02
부산아시아드경기장
```

